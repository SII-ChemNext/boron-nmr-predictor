{% extends "base.html" %}

{% block content %}
<div class="page-container history-page">
    <section class="history-panel">
        <h2 data-i18n="history.title">é¢„æµ‹å†å²è®°å½•</h2>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading-state" class="state-container hidden">
            <div class="spinner"></div>
            <p data-i18n="history.loading">æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>
        </div>

        <!-- å†å²è®°å½•è¡¨æ ¼ -->
        <div id="history-content" class="state-container hidden">
            <div class="table-wrapper">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th data-i18n="history.table.id">ID</th>
                            <th data-i18n="history.table.time">æ—¶é—´</th>
                            <th data-i18n="history.table.smiles">åˆ†å­ SMILES</th>
                            <th data-i18n="history.table.solvent">æº¶å‰‚</th>
                            <th data-i18n="history.table.boronCount">ç¡¼åŸå­æ•°</th>
                            <th data-i18n="history.table.actions">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="empty-state" class="state-container">
            <div class="empty-message">
                <p data-i18n="history.empty">ğŸ“‹ è¿˜æ²¡æœ‰é¢„æµ‹è®°å½•</p>
                <a href="/" class="btn btn-primary" data-i18n="history.goPredict">å»é¢„æµ‹</a>
            </div>
        </div>

        <!-- é”™è¯¯çŠ¶æ€ -->
        <div id="error-state" class="state-container hidden">
            <div class="error-box">
                <h3 data-i18n="history.loadFailed">âš ï¸ åŠ è½½å¤±è´¥</h3>
                <p id="error-message"></p>
                <button id="retry-btn" class="btn btn-primary" data-i18n="history.retry">é‡è¯•</button>
            </div>
        </div>
    </section>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div id="detail-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.detailTitle">é¢„æµ‹è¯¦æƒ…</h3>
                <button id="close-modal-btn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-section">
                    <h4 data-i18n="modal.moleculeInfo">åˆ†å­ä¿¡æ¯</h4>
                    <p><strong data-i18n="modal.smiles">SMILES:</strong> <code id="detail-smiles"></code></p>
                    <p><strong data-i18n="modal.solvent">æº¶å‰‚:</strong> <span id="detail-solvent"></span></p>
                    <p><strong data-i18n="modal.timestamp">æ—¶é—´:</strong> <span id="detail-timestamp"></span></p>
                </div>

                <div class="detail-section">
                    <h4 data-i18n="modal.predictionResult">é¢„æµ‹ç»“æœ</h4>
                    <table class="detail-table">
                        <thead>
                            <tr>
                                <th data-i18n="result.table.atomIndex">åŸå­ç´¢å¼•</th>
                                <th data-i18n="result.table.element">å…ƒç´ </th>
                                <th data-i18n="result.table.predictionPpm">é¢„æµ‹ ppm</th>
                            </tr>
                        </thead>
                        <tbody id="detail-predictions">
                        </tbody>
                    </table>
                </div>

                <div class="detail-section">
                    <h4 data-i18n="modal.moleculeStructure">åˆ†å­ç»“æ„</h4>
                    <div class="image-container">
                        <img id="detail-image" src="" data-i18n="result.moleculeStructureAlt" alt="åˆ†å­ç»“æ„" class="molecule-image">
                    </div>
                </div>

                <div class="detail-section">
                    <h4 data-i18n="modal.operations">æ“ä½œ</h4>
                    <div class="button-group">
                        <button id="detail-load-btn" class="btn btn-primary" data-i18n="modal.loadToEditor">åŠ è½½åˆ°ç¼–è¾‘å™¨</button>
                        <button id="detail-download-csv-btn" class="btn btn-download" data-i18n="result.buttons.downloadCSV">ä¸‹è½½ CSV</button>
                        <button id="detail-download-json-btn" class="btn btn-download" data-i18n="result.buttons.downloadJSON">ä¸‹è½½ JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
document.addEventListener('DOMContentLoaded', loadHistory);

async function loadHistory() {
    const loadingState = document.getElementById('loading-state');
    const contentState = document.getElementById('history-content');
    const emptyState = document.getElementById('empty-state');
    const errorState = document.getElementById('error-state');

    loadingState.classList.remove('hidden');
    contentState.classList.add('hidden');
    emptyState.classList.add('hidden');
    errorState.classList.add('hidden');

    try {
        const response = await fetch('/api/history?limit=100');
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || window.i18n.t('history.loadFailed'));
        }

        if (data.records.length === 0) {
            loadingState.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }

        // å¡«å……è¡¨æ ¼
        const tbody = document.getElementById('history-tbody');
        tbody.innerHTML = '';

        data.records.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${record.id}</td>
                <td>${new Date(record.timestamp).toLocaleString('zh-CN')}</td>
                <td><code class="smiles-cell">${record.mol_smiles}</code></td>
                <td>${record.solvent_name}</td>
                <td>${record.predictions.length}</td>
                <td>
                    <button class="btn-link" onclick="showDetail(${record.id})" data-i18n="history.viewDetail">æŸ¥çœ‹è¯¦æƒ…</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        loadingState.classList.add('hidden');
        contentState.classList.remove('hidden');

    } catch (error) {
        console.error(window.i18n ? window.i18n.t('messages.loadHistoryFailed') : 'åŠ è½½å†å²è®°å½•å¤±è´¥', error);
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
        document.getElementById('error-message').textContent = error.message;
    }
}

async function showDetail(predictionId) {
    try {
        const response = await fetch(`/api/prediction/${predictionId}`);
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || (window.i18n ? window.i18n.t('messages.getDetailFailed') : 'è·å–è¯¦æƒ…å¤±è´¥'));
        }

        const record = data.record;

        // å¡«å……è¯¦æƒ…
        document.getElementById('detail-smiles').textContent = record.mol_smiles;
        document.getElementById('detail-solvent').textContent = record.solvent_name;
        document.getElementById('detail-timestamp').textContent = new Date(record.timestamp).toLocaleString('zh-CN');

        // å¡«å……é¢„æµ‹è¡¨æ ¼
        const tbody = document.getElementById('detail-predictions');
        tbody.innerHTML = '';
        record.predictions.forEach(pred => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${pred.atom_index}</td>
                <td>${pred.element}</td>
                <td>${pred.ppm.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
        });

        // è®¾ç½®å›¾ç‰‡
        if (record.image_path) {
            document.getElementById('detail-image').src = `/api/image/${record.image_path}`;
        }

        // è®¾ç½®æŒ‰é’®äº‹ä»¶
        document.getElementById('detail-load-btn').onclick = () => {
            localStorage.setItem('loadMolecule', record.mol_smiles);
            window.location.href = '/';
        };

        document.getElementById('detail-download-csv-btn').onclick = () => {
            window.location.href = `/api/download/csv/${predictionId}`;
        };

        document.getElementById('detail-download-json-btn').onclick = () => {
            window.location.href = `/api/download/json/${predictionId}`;
        };

        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('detail-modal').classList.remove('hidden');

    } catch (error) {
        console.error(window.i18n ? window.i18n.t('messages.getDetailFailed') : 'è·å–è¯¦æƒ…å¤±è´¥', error);
        alert((window.i18n ? window.i18n.t('messages.getDetailFailed') : 'è·å–è¯¦æƒ…å¤±è´¥') + ': ' + error.message);
    }
}

// å…³é—­å¼¹çª—
document.getElementById('close-modal-btn').addEventListener('click', () => {
    document.getElementById('detail-modal').classList.add('hidden');
});

document.getElementById('detail-modal').addEventListener('click', (e) => {
    if (e.target.id === 'detail-modal') {
        document.getElementById('detail-modal').classList.add('hidden');
    }
});

// é‡è¯•æŒ‰é’®
document.getElementById('retry-btn').addEventListener('click', loadHistory);
</script>
{% endblock %}
